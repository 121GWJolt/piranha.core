piranha.postedit=new Vue({el:"#postedit",data:{loading:!0,id:null,blogId:null,typeId:null,title:null,slug:null,metaKeywords:null,metaDescription:null,published:null,state:"new",categories:[],tags:[],blocks:[],regions:[],editors:[],useBlocks:!0,saving:!1,savingDraft:!1,selectedRegion:{uid:"uid-blocks",name:null,icon:null},selectedSetting:"uid-settings",selectedCategory:null,selectedTags:[]},computed:{contentRegions:function(){return this.regions.filter(function(e){return"setting"!=e.meta.display&&"hidden"!=e.meta.display})},settingRegions:function(){return this.regions.filter(function(e){return"setting"===e.meta.display})}},methods:{bind:function(e){this.id=e.id,this.blogId=e.blogId,this.typeId=e.typeId,this.title=e.title,this.slug=e.slug,this.metaKeywords=e.metaKeywords,this.metaDescription=e.metaDescription,this.published=e.published,this.state=e.state,this.blocks=e.blocks,this.regions=e.regions,this.editors=e.editors,this.categories=e.categories,this.tags=e.tags,this.useBlocks=e.useBlocks,this.selectedCategory=e.selectedCategory,this.selectedTags=e.selectedTags,this.useBlocks||(0<this.editors.length?this.selectedRegion=this.editors[0]:0<this.contentRegions.length&&(this.selectedRegion=this.contentRegions[0].meta))},load:function(e){var t=this;fetch(piranha.baseUrl+"manager/api/post/"+e).then(function(e){return e.json()}).then(function(e){t.bind(e)}).catch(function(e){console.log("error:",e)})},create:function(e,t){var s=this;fetch(piranha.baseUrl+"manager/api/post/create/"+e+"/"+t).then(function(e){return e.json()}).then(function(e){s.bind(e)}).catch(function(e){console.log("error:",e)})},save:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/post/save")},saveDraft:function(){this.savingDraft=!0,this.saveInternal(piranha.baseUrl+"manager/api/post/save/draft")},unpublish:function(){this.saving=!0,this.saveInternal(piranha.baseUrl+"manager/api/post/save/unpublish")},saveInternal:function(e){var s=this,t={id:s.id,blogId:s.blogId,typeId:s.typeId,title:s.title,slug:s.slug,metaKeywords:s.metaKeywords,metaDescription:s.metaDescription,published:s.published,blocks:JSON.parse(JSON.stringify(s.blocks)),regions:JSON.parse(JSON.stringify(s.regions)),selectedCategory:s.selectedCategory,selectedTags:JSON.parse(JSON.stringify(s.selectedTags))};fetch(e,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(function(e){return e.json()}).then(function(e){var t=s.state;s.id=e.id,s.slug=e.slug,s.published=e.published,s.state=e.state,"new"===t&&"new"!==e.state&&window.history.replaceState({state:"created"},"Edit post",piranha.baseUrl+"manager/post/edit/"+e.id),piranha.notifications.push(e.status),s.saving=!1,s.savingDraft=!1}).catch(function(e){console.log("error:",e)})},revert:function(){var t=this;fetch(piranha.baseUrl+"manager/api/post/revert/"+t.id).then(function(e){return e.json()}).then(function(e){t.bind(e),Vue.nextTick(function(){$("#selectedCategory").select2({tags:!0,selectOnClose:!0,placeholder:piranha.resources.texts.addCategory}),$("#selectedTags").select2({tags:!0,selectOnClose:!0,placeholder:piranha.resources.texts.addTags})}),piranha.notifications.push(e.status)}).catch(function(e){console.log("error:",e)})},remove:function(){var t=this;fetch(piranha.baseUrl+"manager/api/post/delete/"+t.id).then(function(e){return e.json()}).then(function(e){piranha.notifications.push(e),window.location=piranha.baseUrl+"manager/page/"+t.blogId}).catch(function(e){console.log("error:",e)})},addBlock:function(e,t){var s=this;fetch(piranha.baseUrl+"manager/api/content/block/"+e).then(function(e){return e.json()}).then(function(e){s.blocks.splice(t,0,e.body)}).catch(function(e){console.log("error:",e)})},moveBlock:function(e,t){this.blocks.splice(t,0,this.blocks.splice(e,1)[0])},collapseBlock:function(e){e.meta.isCollapsed=!e.meta.isCollapsed},removeBlock:function(e){var t=this.blocks.indexOf(e);-1!==t&&this.blocks.splice(t,1)},selectRegion:function(e){this.selectedRegion=e},selectSetting:function(e){this.selectedSetting=e}},created:function(){},updated:function(){var s=this;this.loading?(sortable(".blocks",{handle:".handle",items:":not(.unsortable)"})[0].addEventListener("sortupdate",function(e){s.moveBlock(e.detail.origin.index,e.detail.destination.index)}),$("#selectedCategory").select2({tags:!0,selectOnClose:!0,placeholder:piranha.resources.texts.addCategory}),$("#selectedCategory").on("change",function(){var e=$(this).find("option:selected").text();s.selectedCategory=e}),$("#selectedTags").select2({tags:!0,selectOnClose:!0,placeholder:piranha.resources.texts.addTags}),$("#selectedTags").on("change",function(){var e=$(this).find("option:selected");s.selectedTags=[];for(var t=0;t<e.length;t++)s.selectedTags.push(e[t].text)})):(sortable(".blocks","disable"),sortable(".blocks","enable")),this.loading=!1}});